<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Black Cab Unite v5.4-fix</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQmxhY2sgQ2FiIFVuaXRlIiwic2hvcnRfbmFtZSI6IkJDVSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDAwIiwidGhlbWVfY29sb3IiOiIjZmZkNzAwIn0="/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš•</text></svg>">
  <style>/* ---------- same CSS as v5.4 ---------- */</style>
</head>
<body>
  <div id="map"></div>
  <div id="headerBanner">
    <div id="appTitleContainer">
      <div id="appTitle">Black Cab Unite v5.4-fix</div>
      <div id="statusCaption" class="status-available"><span class="status-dot"></span>Available</div>
    </div>
    <button id="menuBtn">â˜°</button>
  </div>
  <!-- status dropdown, job panel, menu panel, modal, spinner â€¦ identical markup -->
  <script>
    /* =========================================================
       0.  PWA  â€“  service-worker registration
    ========================================================= */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:application/javascript;base64,'+btoa(`
        const CACHE='bcu-v1';
        self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/']))));
        self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));
      `));
    }
  </script>
  <script>
    /* =========================================================
       1.  FIXED BUGS  (see inline comments)
    ========================================================= */
    document.addEventListener('DOMContentLoaded', () => {
      /* ---------- 1-a  driver ID with sanitiser ---------- */
      let DRIVER_ID = localStorage.getItem('driver_id');
      const validateDriverId = id => id && /^[a-zA-Z0-9_-]+$/.test(id);
      if (!DRIVER_ID || !validateDriverId(DRIVER_ID)) {
        do { DRIVER_ID = prompt('Driver name / ID (letters, numbers, -, _):'); }
        while (DRIVER_ID !== null && !validateDriverId(DRIVER_ID));
        if (DRIVER_ID === null) DRIVER_ID = 'driver-' + Math.random().toString(36).slice(2, 10);
        localStorage.setItem('driver_id', DRIVER_ID);
      }

      /* ---------- 1-b  safe JSON parse ---------- */
      const safeJSON = (k, def = []) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; } };
      let driverJobs   = safeJSON(`driver_jobs_${DRIVER_ID}`);
      let pendingJobs  = safeJSON(`pending_jobs_${DRIVER_ID}`);
      let maxRadius    = parseFloat(localStorage.getItem('max_radius_km') || '10');

      /* ---------- 1-c  MQTT port 8883 (WSS) ---------- */
      const MQTT_BROKER = "wss://broker.hivemq.com:8884/mqtt";

      /* ---------- 1-d  global timer ref ---------- */
      let jobTimerInterval = null;
      let jobWakeLock      = null;

      /* ---------- 1-e  TTS init ---------- */
      let ttsInitialized = false;
      const initTTS = () => { if (!ttsInitialized && speechSynthesis) { speechSynthesis.speak(new SpeechSynthesisUtterance('')); ttsInitialized = true; } };
      document.body.addEventListener('click', initTTS, { once: true });

      /* ---------- 1-f  rest of original vars ---------- */
      const REQUEST_TOPIC = 'pubs/requests/+';
      const LOCATION_TOPIC = `drivers/${DRIVER_ID}/location`;
      const CHAT_GROUP_TOPIC = 'chat/group';
      const JOB_RESULT_TOPIC = `jobs/+/result/${DRIVER_ID}`;
      let driverCoords = null, map = null, driverMarker = null, client = null, currentJob = null, isJobActive = false;

      /* ---------- 1-g  only publish when MQTT connected ---------- */
      let lastPublish = 0, lastPublishCoords = null;
      const publishLocationThrottled = gps => {
        if (!client || !client.connected) return;
        const now = Date.now();
        const moved = !lastPublishCoords || distance(lastPublishCoords.lat, lastPublishCoords.lng, gps.lat, gps.lng) > 5;
        if (moved || now - lastPublish > 3000) {
          client.publish(LOCATION_TOPIC, JSON.stringify({ driver: DRIVER_ID, ...gps, ts: now }));
          lastPublish = now; lastPublishCoords = { lat: gps.lat, lng: gps.lng };
        }
      };

      /* ---------- 1-h  distance helper ---------- */
      const distance = (lat1, lon1, lat2, lon2) => {
        const R = 6371000, toRad = x => x * Math.PI / 180;
        const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2), Î”Ï† = toRad(lat2 - lat1), Î”Î» = toRad(lon2 - lon1);
        const a = Math.sin(Î”Ï† / 2) ** 2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      };

      /* ---------- 1-i  map init (unchanged) ---------- */
      const initMap = () => {
        document.getElementById('loadingOverlay').style.display = 'none';
        map = L.map('map').setView([52.4068, -1.5197], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OSM' }).addTo(map);
        driverMarker = L.marker([52.4068, -1.5197], { icon: createBlackCabIcon(0) }).addTo(map);
        initGPS();
      };

      /* ---------- 1-j  GPS with safety ---------- */
      const initGPS = () => {
        if (!navigator.geolocation) { status.textContent = 'Geolocation unavailable'; return; }
        navigator.geolocation.watchPosition(
          pos => {
            const gps = { lat: pos.coords.latitude, lng: pos.coords.longitude, heading: pos.coords.heading || 0, accuracy: pos.coords.accuracy || 50 };
            driverCoords = gps;
            if (driverMarker) driverMarker.setLatLng([gps.lat, gps.lng]).setIcon(createBlackCabIcon(gps.heading));
            publishLocationThrottled(gps);
          },
          err => status.textContent = 'GPS error: ' + err.message,
          { enableHighAccuracy: true, maximumAge: 0, timeout: 8000 }
        );
        connectMQTT();
      };

      /* ---------- 1-k  MQTT connect ---------- */
      const connectMQTT = () => {
        client = mqtt.connect(MQTT_BROKER, { clientId: 'drv-' + DRIVER_ID + '-' + Date.now(), clean: true, reconnectPeriod: 1000 });
        client.on('connect', () => {
          client.subscribe([REQUEST_TOPIC, 'drivers/+/location', CHAT_GROUP_TOPIC, `chat/private/${DRIVER_ID}/+`, JOB_RESULT_TOPIC]);
        });
        client.on('message', (topic, msg) => {
          try {
            const data = JSON.parse(msg.toString());
            if (topic.startsWith('pubs/requests/')) handleJobRequest(data);
            if (topic.startsWith('jobs/') && topic.endsWith(`/result/${DRIVER_ID}`)) handleJobResult(data);
            if (topic === CHAT_GROUP_TOPIC) addMessage('group', data.sender, data.text, data.timestamp);
          } catch {}
        });
      };

      /* ---------- 1-l  job handling ---------- */
      const handleJobRequest = job => {
        if (driverPresence !== 'available') return;
        if (driverCoords && distance(driverCoords.lat, driverCoords.lng, job.lat, job.lng) > maxRadius * 1000) {
          client.publish(`jobs/${job.job}/status`, JSON.stringify({ job: job.job, driver: DRIVER_ID, status: 'rejected', reason: 'out_of_radius' }));
          return;
        }
        pendingJobs.push({ ...job, receivedAt: Date.now() });
        localStorage.setItem(`pending_jobs_${DRIVER_ID}`, JSON.stringify(pendingJobs));
        if (!isJobActive) showJobPanel(job);
      };

      const showJobPanel = job => {
        isJobActive = true; currentJob = job;
        document.getElementById('jobPanel').style.display = 'block';
        document.getElementById('pickupLocation').textContent = `${job.pubName} (${job.lat.toFixed(5)}, ${job.lng.toFixed(5)})`;
        document.getElementById('customerPhone').textContent = job.customerPhone;
        let sec = 30;
        const timerEl = document.getElementById('jobTimer');
        const secEl   = document.getElementById('timerSeconds');
        timerEl.style.display = 'block';
        jobTimerInterval = setInterval(() => {
          secEl.textContent = --sec;
          if (sec <= 0) { cleanupJob(); processNextJob(); }
        }, 1000);
        startVoiceListener();
        if ('wakeLock' in navigator) navigator.wakeLock.request('screen').then(l => jobWakeLock = l);
      };

      const cleanupJob = () => {
        if (jobTimerInterval) { clearInterval(jobTimerInterval); jobTimerInterval = null; }
        document.getElementById('jobPanel').style.display = 'none';
        isJobActive = false; currentJob = null;
        if (jobWakeLock) { jobWakeLock.release(); jobWakeLock = null; }
        stopVoiceListener();
      };

      const respondToJob = accept => {
        if (!currentJob || !client) return;
        const topic = accept ? `jobs/${currentJob.job}/accept` : `jobs/${currentJob.job}/status`;
        const payload = accept
          ? { job: currentJob.job, driver: DRIVER_ID, lat: driverCoords?.lat, lng: driverCoords?.lng }
          : { job: currentJob.job, driver: DRIVER_ID, status: 'rejected' };
        client.publish(topic, JSON.stringify(payload));
        cleanupJob(); processNextJob();
      };

      /* ---------- 1-m  voice ---------- */
      let speechRec = null;
      const startVoiceListener = () => {
        if (speechRec || !('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) return;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRec = new SR(); speechRec.lang = 'en-US'; speechRec.continuous = false;
        speechRec.onresult = e => {
          const t = e.results[0][0].transcript.toLowerCase();
          if (/\baccept\b/.test(t)) respondToJob(true);
          if (/\breject\b/.test(t)) respondToJob(false);
        };
        speechRec.onend = () => { if (isJobActive) setTimeout(startVoiceListener, 500); };
        speechRec.start();
      };
      const stopVoiceListener = () => { if (speechRec) { speechRec.abort(); speechRec = null; } };

      /* ---------- 1-n  driver presence ---------- */
      let driverPresence = localStorage.getItem('driver_presence') || 'available';
      const setPresence = s => {
        driverPresence = s; localStorage.setItem('driver_presence', s);
        document.getElementById('statusCaption').className = `status-${s}`;
        document.getElementById('statusCaption').innerHTML = `<span class="status-dot"></span>${s.charAt(0).toUpperCase() + s.slice(1)}`;
      };
      document.getElementById('appTitleContainer').addEventListener('click', () => {
        const d = document.getElementById('statusDropdown');
        d.style.display = d.style.display === 'flex' ? 'none' : 'flex';
      });
      document.querySelectorAll('.status-option').forEach(btn => btn.addEventListener('click', e => {
        setPresence(e.currentTarget.dataset.status);
        document.getElementById('statusDropdown').style.display = 'none';
      }));
      document.getElementById('logOffBtn').addEventListener('click', () => setPresence('offline'));

      /* ---------- 1-o  UI bindings ---------- */
      document.getElementById('acceptBtn').addEventListener('click', () => respondToJob(true));
      document.getElementById('rejectBtn').addEventListener('click', () => respondToJob(false));
      document.getElementById('menuBtn').addEventListener('click', () => {
        const p = document.getElementById('menuPanel');
        p.classList.toggle('active');
        if (p.classList.contains('active')) renderCurrentView();
      });

      /* ---------- 1-p  black-cab icon ---------- */
      const createBlackCabIcon = (h = 0) => L.divIcon({
        html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 58 36" width="58" height="36" style="transform:rotate(${h}deg)"><rect x="4" y="14" width="50" height="14" rx="3" fill="#000"/><path d="M18 14v-4c0-3 2-5 5-5h12c3 0 5 2 5 5v4h-22z" fill="#000"/><rect x="25" y="4" width="8" height="3" rx="1" fill="#FFD700"/><text x="29" y="6.6" text-anchor="middle" font-size="2.2" font-weight="bold" fill="#000">TAXI</text><circle cx="15" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/><circle cx="43" cy="28" r="4" fill="#fff" stroke="#000" stroke-width="1"/></svg>`,
        iconSize: [58, 36], iconAnchor: [29, 18], className: 'taxi-marker'
      });

      /* ---------- 1-q  init ---------- */
      initMap();
    });
  </script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</body>
</html>

